# CMakeLists.txt para Compila√ß√£o WebAssembly
# Este arquivo adiciona suporte para compilar Fallout 2 para WebAssembly usando Emscripten
# 
# USO:
#   1. Instale Emscripten: https://emscripten.org/docs/getting_started/downloads.html
#   2. source ./emsdk/emsdk_env.sh
#   3. mkdir build-web && cd build-web
#   4. emcmake cmake -DCMAKE_TOOLCHAIN_FILE=../CMakeLists_WebAssembly.txt ..
#   5. emmake make

cmake_minimum_required(VERSION 3.13)

# Detectar se estamos usando Emscripten
if(CMAKE_SYSTEM_NAME STREQUAL "Emscripten")
    message(STATUS "üîß Configurando para WebAssembly/Emscripten")
    
    # Configura√ß√µes b√°sicas
    set(CMAKE_EXECUTABLE_SUFFIX ".html")
    set(CMAKE_CXX_STANDARD 17)
    set(CMAKE_CXX_STANDARD_REQUIRED YES)
    
    # Flags do Emscripten
    set(EMSCRIPTEN_FLAGS "")
    
    # SDL2 via Emscripten
    set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} -s USE_SDL=2")
    set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} -s USE_SDL_IMAGE=2")
    set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} -s SDL2_IMAGE_FORMATS='[\"png\",\"jpg\"]'")
    
    # zlib via Emscripten
    set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} -s USE_ZLIB=1")
    
    # WebAssembly
    set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} -s WASM=1")
    set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} -s ALLOW_MEMORY_GROWTH=1")
    set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} -s INITIAL_MEMORY=67108864")  # 64MB inicial
    
    # Sistema de arquivos
    set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} -s FORCE_FILESYSTEM=1")
    set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} -s EXPORTED_RUNTIME_METHODS='[\"FS\",\"ccall\",\"cwrap\"]'")
    
    # Otimiza√ß√µes
    set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} -O2")
    set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} -s ASSERTIONS=0")
    
    # Preload de assets (ajustar caminhos conforme necess√°rio)
    # set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} --preload-file \"../Fallout 2/master.dat@/master.dat\"")
    # set(EMSCRIPTEN_FLAGS "${EMSCRIPTEN_FLAGS} --preload-file \"../Fallout 2/critter.dat@/critter.dat\"")
    
    # Aplicar flags
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${EMSCRIPTEN_FLAGS}")
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${EMSCRIPTEN_FLAGS}")
    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} ${EMSCRIPTEN_FLAGS}")
    
    # Desabilitar depend√™ncias vendored (usar do Emscripten)
    set(FALLOUT_VENDORED OFF CACHE BOOL "Use vendored libraries" FORCE)
    
    message(STATUS "‚úÖ Configura√ß√£o WebAssembly conclu√≠da")
    message(STATUS "   Flags: ${EMSCRIPTEN_FLAGS}")
else()
    message(FATAL_ERROR "Este arquivo deve ser usado apenas com Emscripten!")
endif()

